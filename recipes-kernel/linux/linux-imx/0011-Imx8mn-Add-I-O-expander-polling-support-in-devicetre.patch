From f3a5438782b6a551f626604799df310be548dc75 Mon Sep 17 00:00:00 2001
From: Alvaro-solidrun <alvaro.karsz@solid-run.com>
Date: Wed, 9 Jun 2021 10:56:28 +0300
Subject: [PATCH] Imx8mn - Add I/O expander polling support in devicetree

---
 .../boot/dts/freescale/imx8mn-compact.dts     | 25 ++++++++++++++++---
 1 file changed, 21 insertions(+), 4 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/imx8mn-compact.dts b/arch/arm64/boot/dts/freescale/imx8mn-compact.dts
index b137b77d53c0..384aa2f68673 100755
--- a/arch/arm64/boot/dts/freescale/imx8mn-compact.dts
+++ b/arch/arm64/boot/dts/freescale/imx8mn-compact.dts
@@ -6,6 +6,7 @@
 /dts-v1/;
 
 #include <dt-bindings/usb/pd.h>
+#include <dt-bindings/input/input.h>
 #include "imx8mn.dtsi"
 
 / {
@@ -82,6 +83,21 @@
 		enable-active-high;
 	};
 
+	/*poll IO Expander and reboot in case of power loss*/
+	gpio_keys_polled {
+			compatible = "gpio-keys-polled";
+			#address-cells = <1>;
+	                #size-cells = <0>;
+			poll-interval = <1000>; /*1 sec*/
+			autorepeat; /*for cases when key was triggered before daemon was started*/
+			button@0 {
+				label = "reset";
+				linux,code = <KEY_RESTART>;
+				gpios = <&io_expander 1 GPIO_ACTIVE_LOW>;
+	       	                debounce-interval = <100>;
+			};
+	};
+
       clocks {
                clk24m: clk24m {
                        compatible = "fixed-clock";
@@ -484,17 +500,18 @@
 	status = "okay";
 
         io_expander: gpio-controller@20 {
+		/*ignore interrupts - using polling method (gpio-keys-polled)*/
                 compatible = "ti,tca6408";
                 reg = <0x20>;
                 pinctrl-names = "default";
                 pinctrl-0 = <&pinctrl_io_expander>;
-                interrupt-controller;
-                #interrupt-cells = <2>;
+		//interrupt-controller;
+		//#interrupt-cells = <2>;
                 reset-gpios = <&gpio3 16 GPIO_ACTIVE_LOW>;
                 gpio-controller;
                 #gpio-cells = <2>;
-                interrupt-parent = <&gpio2>;
-                interrupts = <11 IRQ_TYPE_EDGE_FALLING>;
+		//interrupt-parent = <&gpio2>;
+		//interrupts = <11 IRQ_TYPE_EDGE_FALLING>;
         };
 
 	rtc@69 {
-- 
2.25.1

